<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>AntiquaVision Master</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>

body{
 margin:0;
 background:#0b0e14;
 color:#eee;
 font-family:Arial;
}

header{
 background:#111;
 padding:15px;
 text-align:center;
 color:gold;
 font-size:22px;
}

.container{
 max-width:1500px;
 margin:auto;
 padding:20px;
}

.card{
 background:#151922;
 padding:20px;
 border-radius:12px;
 margin-bottom:20px;
}

button{
 background:gold;
 border:none;
 padding:8px 14px;
 border-radius:6px;
 font-weight:bold;
 cursor:pointer;
}

input,select{
 width:100%;
 padding:7px;
 margin:5px 0;
 background:#0b0e14;
 color:white;
 border:1px solid #333;
}

table{
 width:100%;
 border-collapse:collapse;
 font-size:13px;
}

th,td{
 border-bottom:1px solid #333;
 padding:6px;
}

th{color:gold}

.grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
 gap:15px;
}

.kpi{
 background:#0b0e14;
 border:1px solid #333;
 padding:12px;
 border-radius:8px;
 text-align:center;
}

</style>
</head>

<body>

<header>
AntiquaVision MASTER â€” Business Intelligence
</header>

<div class="container">

<!-- IMPORT -->

<div class="card">

<h3>ğŸ“‚ Carica File</h3>

<input type="file" id="fileInput">

<button onclick="loadFile()">Analizza</button>

<div id="result"></div>

</div>

<!-- KPI -->

<div class="card">

<h3>ğŸ“Š Indicatori</h3>

<div class="grid" id="kpi"></div>

</div>

<!-- GRAFICI BASE -->

<div class="card">
<h3>ğŸ“ˆ Vendite Mensili</h3>
<select id="typeSales" onchange="drawSalesChart()">
<option>bar</option><option>line</option><option>pie</option><option>doughnut</option>
</select>
<canvas id="salesChart"></canvas>
</div>

<div class="card">
<h3>ğŸ’° Profitto per Categoria</h3>
<select id="typeProfit" onchange="drawProfitChart()">
<option>bar</option><option>line</option><option>pie</option><option>doughnut</option>
</select>
<canvas id="profitChart"></canvas>
</div>

<div class="card">
<h3>ğŸŒ Paesi</h3>
<select id="typeCountry" onchange="drawCountryChart()">
<option>bar</option><option>pie</option><option>doughnut</option>
</select>
<canvas id="countryChart"></canvas>
</div>

<div class="card">
<h3>ğŸ›ï¸ Epoche</h3>
<select id="typeEra" onchange="drawEraChart()">
<option>bar</option><option>line</option><option>pie</option><option>doughnut</option>
</select>
<canvas id="eraChart"></canvas>
</div>

<!-- NUOVE ANALISI -->

<div class="card">
<h3>ğŸº Tipologie piÃ¹ Vendute</h3>
<canvas id="typeChart"></canvas>
</div>

<div class="card">
<h3>ğŸ›’ Acquisti per Epoca</h3>
<canvas id="buyEraChart"></canvas>
</div>

<div class="card">
<h3>ğŸ“¦ QuantitÃ  per Categoria</h3>
<canvas id="qtyChart"></canvas>
</div>

<div class="card">
<h3>ğŸ“‰ Perdite per Canale</h3>
<canvas id="lossChart"></canvas>
</div>

<div class="card">
<h3>ğŸ’ Profitto per Oggetto</h3>
<canvas id="objChart"></canvas>
</div>

<!-- AI -->

<div class="card">
<h3>ğŸ¤– Consulente AI</h3>
<div id="ai"></div>
</div>

<!-- TABELLA -->

<div class="card">
<h3>ğŸ“‹ Archivio Completo</h3>
<table id="table"></table>
</div>

</div>

<script>

let data=[];
let charts={};

/* LOAD */

function loadFile(){

 let f=fileInput.files[0];
 if(!f) return alert("Seleziona file");

 let ext=f.name.split(".").pop().toLowerCase();

 if(ext==="xlsx") readExcel(f);
 else readCSV(f);
}

/* EXCEL */

function readExcel(f){

 let r=new FileReader();

 r.onload=e=>{

  let a=new Uint8Array(e.target.result);

  let wb=XLSX.read(a,{type:"array"});

  let s=wb.Sheets[wb.SheetNames[0]];

  process(XLSX.utils.sheet_to_json(s));
 };

 r.readAsArrayBuffer(f);
}

/* CSV */

function readCSV(f){

 Papa.parse(f,{
  header:true,
  skipEmptyLines:true,
  complete:r=>process(r.data)
 });
}

/* PROCESS */

function process(rows){

 data=[];

 rows.forEach(r=>{

  function num(v){
   return Number(
    String(v||"")
    .replace("â‚¬","")
    .replace("%","")
    .replace(",",".")
    .replace(/\s/g,"")
   )||0;
  }

  data.push({

   nome:r["Merce venduta"]||"",
   tipo:r["TIPOLOGIA"]||"",
   epoca:r["epoca"]||"",
   paese:r["Nazionalita acquirente"]||"",
   sito:r["luogo di vendita"]||"",
   mese:r["MeseNorm"]||"",

   prezzo:num(r["prezzo di vendita"]),
   costo:num(r["acquisto"]),
   profitto:num(r["profitto"]),
   margine:num(r["margine %"])
  });
 });

 result.innerHTML="âœ”ï¸ "+data.length+" record caricati";

 renderAll();
}

/* MAIN */

function renderAll(){

 renderKPI();
 renderTable();

 drawSalesChart();
 drawProfitChart();
 drawCountryChart();
 drawEraChart();

 drawTypeChart();
 drawBuyEraChart();
 drawQtyChart();
 drawLossChart();
 drawObjChart();

 renderAI();
}

/* KPI */

function renderKPI(){

 let r=0,c=0,p=0;

 data.forEach(x=>{
  r+=x.prezzo;
  c+=x.costo;
  p+=x.profitto;
 });

 let roi=(p/c*100)||0;

 kpi.innerHTML=`

 <div class="kpi"><b>${r.toFixed(0)}â‚¬</b><br>Entrate</div>
 <div class="kpi"><b>${c.toFixed(0)}â‚¬</b><br>Costi</div>
 <div class="kpi"><b>${p.toFixed(0)}â‚¬</b><br>Profitto</div>
 <div class="kpi"><b>${roi.toFixed(1)}%</b><br>ROI</div>
 <div class="kpi"><b>${data.length}</b><br>Oggetti</div>

 `;
}

/* UTILS */

function group(k,v){

 let o={};

 data.forEach(x=>{
  if(!x[k]) return;
  o[x[k]]=(o[x[k]]||0)+x[v];
 });

 return o;
}

function count(k){

 let o={};

 data.forEach(x=>{
  if(!x[k]) return;
  o[x[k]]=(o[x[k]]||0)+1;
 });

 return o;
}

function draw(id,ref,type,label,obj){

 if(charts[ref]) charts[ref].destroy();

 charts[ref]=new Chart(document.getElementById(id),{
  type:type,
  data:{
   labels:Object.keys(obj),
   datasets:[{
    label,
    data:Object.values(obj),
    backgroundColor:"gold"
   }]
  }
 });
}

/* BASE */

function drawSalesChart(){
 draw("salesChart","sales",typeSales.value,"Vendite",group("mese","prezzo"));
}

function drawProfitChart(){
 draw("profitChart","profit",typeProfit.value,"Profitto",group("tipo","profitto"));
}

function drawCountryChart(){
 draw("countryChart","country",typeCountry.value,"Paesi",group("paese","prezzo"));
}

function drawEraChart(){
 draw("eraChart","era",typeEra.value,"Epoche",group("epoca","profitto"));
}

/* EXTRA */

function drawTypeChart(){
 draw("typeChart","type","bar","Tipologie",count("tipo"));
}

function drawBuyEraChart(){
 draw("buyEraChart","buyEra","bar","Acquisti Epoca",group("epoca","costo"));
}

function drawQtyChart(){
 draw("qtyChart","qty","bar","QuantitÃ ",count("nome"));
}

function drawLossChart(){

 let o={};

 data.forEach(x=>{
  if(x.profitto<0){
   o[x.sito]=(o[x.sito]||0)+x.profitto;
  }
 });

 draw("lossChart","loss","bar","Perdite",o);
}

function drawObjChart(){
 draw("objChart","obj","bar","Profitto Oggetti",group("nome","profitto"));
}

/* TABLE */

function renderTable(){

 let h="<tr><th>Nome</th><th>Tipo</th><th>Mese</th><th>Prezzo</th><th>Profitto</th><th>Epoca</th></tr>";

 data.forEach(x=>{

  h+=`
  <tr>
   <td>${x.nome}</td>
   <td>${x.tipo}</td>
   <td>${x.mese}</td>
   <td>${x.prezzo}</td>
   <td>${x.profitto}</td>
   <td>${x.epoca}</td>
  </tr>`;
 });

 table.innerHTML=h;
}

/* AI */

function renderAI(){

 let bestType=max(group("tipo","profitto"));
 let bestEra=max(group("epoca","profitto"));
 let worstSite=min(group("sito","profitto"));

 ai.innerHTML=`

 âœ… Miglior tipologia: <b>${bestType}</b><br>
 ğŸ›ï¸ Epoca piÃ¹ redditizia: <b>${bestEra}</b><br>
 âš ï¸ Canale debole: <b>${worstSite}</b><br><br>

 ğŸ“Œ Consiglio:
 investi su <b>${bestEra}</b> (${bestType})
 ed evita <b>${worstSite}</b>.

 `;
}

function max(o){

 let m=-Infinity,k="";

 for(let x in o){
  if(o[x]>m){m=o[x];k=x;}
 }

 return k||"N/D";
}

function min(o){

 let m=Infinity,k="";

 for(let x in o){
  if(o[x]<m){m=o[x];k=x;}
 }

 return k||"N/D";
}

</script>

</body>
</html>
