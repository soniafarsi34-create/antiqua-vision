<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>AntiquaVision Pro Dashboard</title>

<!-- LIB -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>

/* ===== DESIGN ===== */

body{
 margin:0;
 background:linear-gradient(180deg,#07090f,#0b0e14);
 color:#eee;
 font-family:"Segoe UI",Arial;
}

header{
 background:linear-gradient(90deg,#111,#1a1f2e);
 padding:18px;
 text-align:center;
 color:gold;
 font-size:26px;
 font-weight:700;
 letter-spacing:1px;
 box-shadow:0 3px 10px black;
}

.lang{
 margin-top:8px;
}

.container{
 max-width:1800px;
 margin:auto;
 padding:25px;
}

.card{
 background:linear-gradient(180deg,#141826,#151922);
 padding:22px;
 border-radius:14px;
 margin-bottom:22px;
 box-shadow:0 0 15px rgba(0,0,0,.4);
}

button{
 background:linear-gradient(90deg,gold,#ffcc33);
 border:none;
 padding:7px 15px;
 border-radius:8px;
 font-weight:700;
 cursor:pointer;
 transition:.2s;
}

button:hover{
 transform:scale(1.05);
}

input,select{
 width:100%;
 padding:7px;
 margin:4px 0;
 background:#0b0e14;
 color:white;
 border:1px solid #333;
 border-radius:6px;
}

.grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
 gap:14px;
}

.kpi{
 background:#0b0e14;
 border:1px solid #333;
 padding:14px;
 border-radius:10px;
 text-align:center;
 font-size:15px;
}

.flex{
 display:flex;
 justify-content:space-between;
 align-items:center;
}

.small{
 font-size:13px;
 color:#bbb;
 line-height:1.5;
 margin-top:8px;
}

canvas{
 margin-top:10px;
}

hr{
 border:1px solid #222;
 margin:15px 0;
}

</style>
</head>

<body>

<header>
AntiquaVision â€” Professional Business Intelligence

<div class="lang">
<button onclick="setLang('it')">ğŸ‡®ğŸ‡¹</button>
<button onclick="setLang('en')">ğŸ‡¬ğŸ‡§</button>
<button onclick="setLang('de')">ğŸ‡©ğŸ‡ª</button>
<button onclick="setLang('fr')">ğŸ‡«ğŸ‡·</button>
</div>
</header>

<div class="container">

<!-- IMPORT -->

<div class="card">

<h3>ğŸ“‚ Importa File Excel / CSV</h3>

<input type="file" id="file">

<button onclick="loadFile()">Analizza</button>

<div id="res"></div>

</div>

<!-- KPI -->

<div class="card">

<h3>ğŸ“Š Dashboard Generale</h3>

<div class="grid" id="kpi"></div>

<div class="small">
Ricavi = Incassi â€¢ Costi = Spese â€¢ Profitto = Guadagno â€¢ ROI = Rendimento
</div>

</div>

<!-- GUIDE -->

<div class="card">

<h3>ğŸ“˜ Guida Strategica</h3>

<div class="small">

ROI &gt;30% = Ottimo investimento<br>
15â€“30% = Migliorabile<br>
&lt;15% = Rischio<br><br>

Premium &gt;30% fatturato = Punta su opere importanti<br>
Volume â‰  Profitto

</div>

</div>

<!-- CHARTS -->

<!-- RICAVI -->
<div class="card">
<div class="flex">
<h3>ğŸ“ˆ Ricavi per Canale</h3>
<select id="t1" onchange="drawCharts()">
<option>bar</option><option>line</option><option>doughnut</option>
</select>
</div>
<canvas id="c1"></canvas>
<div class="small" id="c1Mini"></div>
</div>

<!-- PROFITTO -->
<div class="card">
<div class="flex">
<h3>ğŸ›ï¸ Profitto per Epoca</h3>
<select id="t2" onchange="drawCharts()">
<option>bar</option><option>line</option><option>doughnut</option>
</select>
</div>
<canvas id="c2"></canvas>
<div class="small" id="c2Mini"></div>
</div>

<!-- ROI EPOCA -->
<div class="card">
<div class="flex">
<h3>ğŸ“Š ROI per Epoca</h3>
<select id="t3" onchange="drawCharts()">
<option>bar</option><option>line</option>
</select>
</div>
<canvas id="c3"></canvas>
<div class="small" id="c3Mini"></div>
</div>

<!-- ROI TIPO -->
<div class="card">
<div class="flex">
<h3>ğŸ“Š ROI per Categoria</h3>
<select id="t4" onchange="drawCharts()">
<option>bar</option><option>line</option>
</select>
</div>
<canvas id="c4"></canvas>
<div class="small" id="c4Mini"></div>
</div>

<!-- COSTI -->
<div class="card">
<div class="flex">
<h3>ğŸ’¸ Margine (Prezzo - Costo)</h3>
<select id="t5" onchange="drawCharts()">
<option>bar</option><option>line</option>
</select>
</div>
<canvas id="c5"></canvas>
<div class="small" id="c5Mini"></div>
</div>

<!-- VOLUME -->
<div class="card">
<div class="flex">
<h3>ğŸ“¦ Profitto Medio per Canale</h3>
<select id="t6" onchange="drawCharts()">
<option>bar</option><option>line</option>
</select>
</div>
<canvas id="c6"></canvas>
<div class="small" id="c6Mini"></div>
</div>

<!-- PREMIUM -->

<div class="card">

<h3>ğŸ’ Impatto Vendite Premium (&gt;1000â‚¬)</h3>

<div id="premiumImpact"></div>

<canvas id="c7"></canvas>

<div class="small" id="c7Mini"></div>

</div>

<!-- FORECAST -->

<div class="card">

<h3>ğŸ”® Previsioni Automatiche (Trend Futuro)</h3>

<canvas id="c8"></canvas>

<div class="small" id="forecastText"></div>

</div>

<!-- AI -->

<div class="card">

<h3>ğŸ¤– Consulente AI</h3>

<div id="ai"></div>

</div>

</div>

<script>

/* ================= DATA ================= */

let all=[],filtered=[];
let charts={};

/* ================= LOAD ================= */

function loadFile(){

 let f=file.files[0];
 if(!f) return alert("Carica file");

 let ext=f.name.split(".").pop().toLowerCase();

 if(ext==="xlsx"){

  let r=new FileReader();

  r.onload=e=>{
   let wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
   prepare(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
  };

  r.readAsArrayBuffer(f);

 }else{

  Papa.parse(f,{
   header:true,
   skipEmptyLines:true,
   complete:r=>prepare(r.data)
  });
 }
}

/* ================= PREPARE ================= */

function prepare(rows){

 all=rows.map(r=>({

  epoca:r["epoca"]||"",
  tipo:r["TIPOLOGIA"]||"",
  paese:r["Nazionalita acquirente"]||"",
  canale:r["luogo di vendita"]||"",
  mese:r["MeseNorm"]||"",

  prezzo:num(r["prezzo di vendita"]),
  costo:num(r["acquisto"]),
  profitto:num(r["profitto"])

 }));

 filtered=[...all];

 res.innerHTML="âœ”ï¸ "+all.length+" record caricati";

 render();
}

/* ================= NUM ================= */

function num(v){

 return Number(String(v||"")
 .replace("â‚¬","")
 .replace("%","")
 .replace(",",".")
 .replace(/\s/g,""))||0;
}

/* ================= GROUP ================= */

function group(arr,k,v){

 let o={};

 arr.forEach(x=>{
  if(!x[k])return;
  o[x[k]]=(o[x[k]]||0)+x[v];
 });

 return o;
}

/* ================= MINI ================= */

function miniStats(obj){

 let k=Object.keys(obj);
 let v=Object.values(obj);

 if(!v.length) return null;

 let max=-1e9,min=1e9,sum=0;
 let maxK="",minK="";

 v.forEach((x,i)=>{
  sum+=x;
  if(x>max){max=x;maxK=k[i]}
  if(x<min){min=x;minK=k[i]}
 });

 return{
  max,maxK,min,minK,avg:sum/v.length
 };
}

function renderMini(id,obj){

 let s=miniStats(obj);
 if(!s)return;

 document.getElementById(id+"Mini").innerHTML=`

 â­ Migliore: ${s.maxK} (${s.max.toFixed(0)})<br>
 âš ï¸ Peggiore: ${s.minK} (${s.min.toFixed(0)})<br>
 ğŸ“Š Media: ${s.avg.toFixed(0)}

 `;
}

/* ================= RENDER ================= */

function render(){

 if(!filtered.length)return;

 renderKPI();
 drawCharts();
 renderAI();
 renderPremium();
 renderForecast();
}

/* ================= KPI ================= */

function renderKPI(){

 let r=0,c=0,p=0;

 filtered.forEach(x=>{
  r+=x.prezzo;
  c+=x.costo;
  p+=x.profitto;
 });

 let roi=(p/c*100)||0;

 kpi.innerHTML=`

 <div class="kpi"><b>${r.toFixed(0)}â‚¬</b><br>Ricavi</div>
 <div class="kpi"><b>${c.toFixed(0)}â‚¬</b><br>Costi</div>
 <div class="kpi"><b>${p.toFixed(0)}â‚¬</b><br>Profitto</div>
 <div class="kpi"><b>${roi.toFixed(1)}%</b><br>ROI</div>
 <div class="kpi"><b>${filtered.length}</b><br>Vendite</div>

 `;
}

/* ================= CHARTS ================= */

function drawCharts(){

 let o1=group(filtered,"canale","prezzo");
 draw("c1","Ricavi",o1,t1.value); renderMini("c1",o1);

 let o2=group(filtered,"epoca","profitto");
 draw("c2","Profitto",o2,t2.value); renderMini("c2",o2);

 let o3=roiBy("epoca");
 draw("c3","ROI",o3,t3.value); renderMini("c3",o3);

 let o4=roiBy("tipo");
 draw("c4","ROI",o4,t4.value); renderMini("c4",o4);

 let o5=marginByType();
 draw("c5","Margine",o5,t5.value); renderMini("c5",o5);

 let o6=volumeProfit();
 draw("c6","Profitto Medio",o6,t6.value); renderMini("c6",o6);

 drawPremiumChart();
}

/* ================= DRAW ================= */

function draw(id,label,obj,type){

 if(charts[id])charts[id].destroy();

 charts[id]=new Chart(document.getElementById(id),{
  type,
  data:{
   labels:Object.keys(obj),
   datasets:[{
    label,
    data:Object.values(obj),
    backgroundColor:"#d4af37",
    borderColor:"#ffcc33",
    borderWidth:2,
    tension:.3,
    fill:false
   }]
  },
  options:{
   responsive:true,
   plugins:{
    legend:{labels:{color:"#eee"}}
   },
   scales:{
    x:{ticks:{color:"#aaa"}},
    y:{ticks:{color:"#aaa"}}
   }
  }
 });
}

/* ================= ANALYTICS ================= */

function roiBy(key){

 let m={};

 filtered.forEach(x=>{

  if(!x[key])return;

  if(!m[x[key]])m[x[key]]={p:0,c:0};

  m[x[key]].p+=x.profitto;
  m[x[key]].c+=x.costo;
 });

 let r={};

 for(let k in m){
  r[k]=(m[k].p/m[k].c*100)||0;
 }

 return r;
}

function marginByType(){

 let r={};

 filtered.forEach(x=>{

  let k=x.tipo||"Altro";

  r[k]=(r[k]||0)+(x.prezzo-x.costo);
 });

 return r;
}

function volumeProfit(){

 let r={};

 filtered.forEach(x=>{

  let k=x.canale||"Altro";

  if(!r[k])r[k]={p:0,c:0};

  r[k].p+=x.profitto;
  r[k].c++;
 });

 let o={};

 for(let k in r){
  o[k]=r[k].p/r[k].c;
 }

 return o;
}

/* ================= PREMIUM ================= */

function analyzePremium(){

 let total=filtered.length,rev=0;
 let pc=0,pr=0;

 filtered.forEach(x=>{

  rev+=x.prezzo;

  if(x.prezzo>=1000){
   pc++;
   pr+=x.prezzo;
  }
 });

 return{
  total,rev,pc,pr,
  percC:(pc/total*100)||0,
  percR:(pr/rev*100)||0
 };
}

function renderPremium(){

 let p=analyzePremium();

 let s="";

 if(p.percR>40)s="ğŸ”¥ Premium dominante";
 else if(p.percR>25)s="âœ… Premium strategico";
 else s="âš ï¸ Focus fascia media";

 premiumImpact.innerHTML=`

 Vendite totali: <b>${p.total}</b><br>
 Fatturato: <b>${p.rev.toFixed(0)}â‚¬</b><br><br>

 >1000â‚¬: <b>${p.pc}</b> (${p.percC.toFixed(1)}%)<br>
 Incasso: <b>${p.pr.toFixed(0)}â‚¬</b> (${p.percR.toFixed(1)}%)<br><br>

 Strategia: <b>${s}</b>

 `;
}

function drawPremiumChart(){

 let p=analyzePremium();

 let o={
  "Premium >1000â‚¬":p.pr,
  "Altri":p.rev-p.pr
 };

 draw("c7","Premium",o,"doughnut");
 renderMini("c7",o);
}

/* ================= FORECAST ================= */

function renderForecast(){

 let byMonth=group(filtered,"mese","prezzo");

 let m=Object.keys(byMonth).sort();
 let v=m.map(x=>byMonth[x]);

 if(v.length<2) return;

 let trend=(v[v.length-1]-v[0])/v.length;

 let future=[];

 let last=v[v.length-1];

 for(let i=1;i<=6;i++){
  last+=trend;
  future.push(last);
 }

 let labels=[...m,"+1","+2","+3","+4","+5","+6"];

 let data=[...v,...future];

 draw("c8","Forecast",labels.reduce((a,k,i)=>{
  a[k]=data[i];return a;
 },{}),"line");

 let txt="";

 if(trend>0)txt="ğŸ“ˆ Crescita prevista";
 else txt="ğŸ“‰ Possibile rallentamento";

 forecastText.innerHTML=txt;
}

/* ================= AI ================= */

function renderAI(){

 let bestE=max(roiBy("epoca"));
 let bestT=max(roiBy("tipo"));

 ai.innerHTML=`

 ğŸ›ï¸ Miglior epoca: <b>${bestE}</b><br>
 ğŸº Miglior categoria: <b>${bestT}</b><br><br>

 ğŸ’¡ Strategia:
 Investi su queste aree per crescere.

 `;
}

/* ================= MAX ================= */

function max(o){

 let m=-1e9,k="N/D";

 for(let x in o){
  if(o[x]>m){m=o[x];k=x;}
 }

 return k;
}

</script>

</body>
</html>
