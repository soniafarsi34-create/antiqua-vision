<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>AntiquaVision Smart PRO+</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>

body{
 margin:0;
 background:#0b0e14;
 color:#eee;
 font-family:Arial;
}

header{
 background:#111;
 padding:15px;
 text-align:center;
 color:gold;
 font-size:22px;
}

.container{
 max-width:1500px;
 margin:auto;
 padding:20px;
}

.card{
 background:#151922;
 padding:20px;
 border-radius:12px;
 margin-bottom:20px;
}

button{
 background:gold;
 border:none;
 padding:8px 14px;
 border-radius:6px;
 font-weight:bold;
 cursor:pointer;
}

input,select{
 width:100%;
 padding:7px;
 margin:5px 0;
 background:#0b0e14;
 color:white;
 border:1px solid #333;
}

table{
 width:100%;
 border-collapse:collapse;
 font-size:12px;
}

th,td{
 border-bottom:1px solid #333;
 padding:6px;
}

th{color:gold}

.grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
 gap:15px;
}

.kpi{
 background:#0b0e14;
 border:1px solid #333;
 padding:12px;
 border-radius:8px;
 text-align:center;
}

.alert{
 background:#200;
 border:1px solid red;
 padding:10px;
 border-radius:8px;
 margin-top:10px;
}

.good{
 background:#021;
 border:1px solid green;
 padding:10px;
 border-radius:8px;
 margin-top:10px;
}

</style>
</head>

<body>

<header>
AntiquaVision Smart PRO+ â€” Business Intelligence
</header>

<div class="container">

<!-- IMPORT -->

<div class="card">

<h3>ğŸ“‚ Carica Excel / CSV</h3>

<input type="file" id="fileInput">

<button onclick="loadFile()">Analizza</button>

<div id="result"></div>

</div>

<!-- KPI -->

<div class="card">

<h3>ğŸ“Š Indicatori Principali</h3>

<div class="grid" id="kpi"></div>

</div>

<!-- SALES -->

<div class="card">

<h3>ğŸ“ˆ Vendite per Mese</h3>

<select id="typeSales" onchange="drawSalesChart()">
<option>bar</option>
<option>line</option>
<option>pie</option>
<option>doughnut</option>
</select>

<canvas id="salesChart"></canvas>

</div>

<!-- PROFIT -->

<div class="card">

<h3>ğŸ’° Profitto per Tipologia</h3>

<select id="typeProfit" onchange="drawProfitChart()">
<option>bar</option>
<option>line</option>
<option>pie</option>
<option>doughnut</option>
</select>

<canvas id="profitChart"></canvas>

</div>

<!-- COUNTRY -->

<div class="card">

<h3>ğŸŒ Vendite per Paese</h3>

<select id="typeCountry" onchange="drawCountryChart()">
<option>bar</option>
<option>pie</option>
<option>doughnut</option>
</select>

<canvas id="countryChart"></canvas>

</div>

<!-- SITE -->

<div class="card">

<h3>ğŸ›’ Vendite per Canale</h3>

<select id="typeSite" onchange="drawSiteChart()">
<option>bar</option>
<option>pie</option>
<option>doughnut</option>
</select>

<canvas id="siteChart"></canvas>

</div>

<!-- ERA -->

<div class="card">

<h3>ğŸ›ï¸ Profitto per Epoca</h3>

<select id="typeEra" onchange="drawEraChart()">
<option>bar</option>
<option>line</option>
<option>pie</option>
<option>doughnut</option>
</select>

<canvas id="eraChart"></canvas>

</div>

<!-- VELOCITA -->

<div class="card">

<h3>âš¡ VelocitÃ  di Vendita (Mesi)</h3>

<canvas id="speedChart"></canvas>

</div>

<!-- MARGINE -->

<div class="card">

<h3>ğŸ“‰ Margine per Tipologia</h3>

<canvas id="marginChart"></canvas>

</div>

<!-- AI -->

<div class="card">

<h3>ğŸ¤– Consigli Strategici AI</h3>

<div id="ai"></div>

</div>

<!-- TABLE -->

<div class="card">

<h3>ğŸ“‹ Tutti i Dati</h3>

<table id="table"></table>

</div>

</div>

<script>

let data=[];
let charts={};

/* LOAD */

function loadFile(){

 let file=fileInput.files[0];

 if(!file){
  alert("Seleziona un file");
  return;
 }

 let ext=file.name.split(".").pop().toLowerCase();

 if(ext==="xlsx") readExcel(file);
 else readCSV(file);
}

/* EXCEL */

function readExcel(file){

 let reader=new FileReader();

 reader.onload=e=>{

  let arr=new Uint8Array(e.target.result);

  let wb=XLSX.read(arr,{type:"array"});

  let sheet=wb.Sheets[wb.SheetNames[0]];

  let json=XLSX.utils.sheet_to_json(sheet);

  process(json);
 };

 reader.readAsArrayBuffer(file);
}

/* CSV */

function readCSV(file){

 Papa.parse(file,{
  header:true,
  skipEmptyLines:true,
  complete:r=>process(r.data)
 });
}

/* PROCESS */

function process(rows){

 data=[];

 rows.forEach(r=>{

  function num(v){
   return Number(
    String(v||"")
    .replace("â‚¬","")
    .replace("%","")
    .replace(",",".")
    .replace(/\s/g,"")
   )||0;
  }

  data.push({

   nome:r["Merce venduta"]||"",
   paese:r["Nazionalita acquirente"]||"",
   sito:r["luogo di vendita"]||"",
   tipo:r["TIPOLOGIA"]||"",
   epoca:r["epoca"]||"",
   mese:r["MeseNorm"]||"",
   anno:r["anno di acquisto"]||"",

   prezzo:num(r["prezzo di vendita"]),
   costo:num(r["acquisto"]),
   profitto:num(r["profitto"]),
   margine:num(r["margine %"])

  });

 });

 result.innerHTML="âœ”ï¸ "+data.length+" record caricati";

 renderAll();
}

/* MAIN */

function renderAll(){

 renderKPI();
 renderTable();

 drawSalesChart();
 drawProfitChart();
 drawCountryChart();
 drawSiteChart();
 drawEraChart();
 drawSpeedChart();
 drawMarginChart();

 renderAI();
}

/* KPI */

function renderKPI(){

 let rev=0,cost=0,prof=0;

 data.forEach(x=>{
  rev+=x.prezzo;
  cost+=x.costo;
  prof+=x.profitto;
 });

 let roi=(prof/cost*100)||0;

 kpi.innerHTML=`

 <div class="kpi"><b>${rev.toFixed(0)}â‚¬</b><br>Entrate</div>
 <div class="kpi"><b>${cost.toFixed(0)}â‚¬</b><br>Costi</div>
 <div class="kpi"><b>${prof.toFixed(0)}â‚¬</b><br>Profitto</div>
 <div class="kpi"><b>${roi.toFixed(1)}%</b><br>ROI</div>
 <div class="kpi"><b>${data.length}</b><br>Vendite</div>

 `;
}

/* GROUP */

function group(key,value){

 let o={};

 data.forEach(x=>{
  if(!x[key]) return;
  o[x[key]]=(o[x[key]]||0)+x[value];
 });

 return o;
}

/* DRAW */

function draw(ref,id,type,label,obj){

 if(charts[ref]) charts[ref].destroy();

 charts[ref]=new Chart(document.getElementById(id),{
  type:type,
  data:{
   labels:Object.keys(obj),
   datasets:[{
    label:label,
    data:Object.values(obj),
    backgroundColor:"gold"
   }]
  }
 });
}

/* CHARTS */

function drawSalesChart(){
 draw("sales","salesChart",typeSales.value,"Vendite",group("mese","prezzo"));
}

function drawProfitChart(){
 draw("profit","profitChart",typeProfit.value,"Profitto",group("tipo","profitto"));
}

function drawCountryChart(){
 draw("country","countryChart",typeCountry.value,"Paesi",group("paese","prezzo"));
}

function drawSiteChart(){
 draw("site","siteChart",typeSite.value,"Canali",group("sito","prezzo"));
}

function drawEraChart(){
 draw("era","eraChart",typeEra.value,"Epoche",group("epoca","profitto"));
}

function drawSpeedChart(){

 let obj={};

 data.forEach(x=>{
  if(!x.anno||!x.mese) return;

  let speed=Math.abs(new Date().getFullYear()-Number(x.anno));

  obj[x.nome]=(obj[x.nome]||0)+speed;
 });

 draw("speed","speedChart","bar","VelocitÃ ",obj);
}

function drawMarginChart(){
 draw("margin","marginChart","bar","Margine",group("tipo","margine"));
}

/* TABLE */

function renderTable(){

 let h="<tr><th>Nome</th><th>Mese</th><th>Tipo</th><th>Prezzo</th><th>Profitto</th><th>Margine</th><th>Epoca</th></tr>";

 data.forEach(x=>{

  h+=`
  <tr>
   <td>${x.nome}</td>
   <td>${x.mese}</td>
   <td>${x.tipo}</td>
   <td>${x.prezzo}</td>
   <td>${x.profitto}</td>
   <td>${x.margine}%</td>
   <td>${x.epoca}</td>
  </tr>
  `;
 });

 table.innerHTML=h;
}

/* AI */

function renderAI(){

 let byType=group("tipo","profitto");
 let bySite=group("sito","profitto");
 let byEra=group("epoca","profitto");
 let byMargin=group("tipo","margine");

 let bestType=maxKey(byType);
 let worstType=minKey(byType);
 let bestSite=maxKey(bySite);
 let bestEra=maxKey(byEra);
 let bestMargin=maxKey(byMargin);

 ai.innerHTML=`

 <div class="good">
 âœ… Miglior tipologia: <b>${bestType}</b><br>
 âœ… Miglior canale: <b>${bestSite}</b><br>
 âœ… Miglior epoca: <b>${bestEra}</b><br>
 âœ… Margine top: <b>${bestMargin}</b>
 </div>

 <div class="alert">
 âš ï¸ Tipologia debole: <b>${worstType}</b><br>
 âš ï¸ Rischio investimento
 </div>

 ğŸ“Œ Strategia:<br>
 Investi in <b>${bestEra}</b> con <b>${bestSite}</b>.
 Riduci acquisti in <b>${worstType}</b>.

 `;
}

function maxKey(o){

 let m=0,k="";

 for(let x in o){
  if(o[x]>m){m=o[x];k=x;}
 }

 return k||"N/D";
}

function minKey(o){

 let m=Infinity,k="";

 for(let x in o){
  if(o[x]<m){m=o[x];k=x;}
 }

 return k||"N/D";
}

</script>

</body>
</html>
