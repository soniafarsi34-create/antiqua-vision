<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>AntiquaVision Master</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>

:root{
 --gold:#d4af37;
 --blue:#4f9cff;
 --green:#3ad29f;
 --red:#ff6b6b;
 --violet:#9b7bff;
 --bg1:#06080f;
 --bg2:#0e1220;
}

body{
 margin:0;
 background:linear-gradient(180deg,var(--bg1),var(--bg2));
 color:#eee;
 font-family:Segoe UI,Arial;
}

header{
 background:linear-gradient(90deg,#0c1020,#1a2040);
 padding:20px;
 text-align:center;
 color:var(--gold);
 font-size:26px;
 font-weight:700;
}

.container{
 max-width:1900px;
 margin:auto;
 padding:25px;
}

.card{
 background:#141a33;
 padding:22px;
 border-radius:16px;
 margin-bottom:24px;
 border:1px solid #1f2750;
 box-shadow:0 0 20px rgba(0,0,0,.6);
}

.grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
 gap:14px;
}

.kpi{
 background:#070b18;
 padding:15px;
 border-radius:12px;
 text-align:center;
 border:1px solid #2a3366;
}

button{
 background:linear-gradient(90deg,var(--gold),#ffd966);
 border:none;
 padding:8px 16px;
 border-radius:10px;
 font-weight:700;
 cursor:pointer;
}

input,select{
 width:100%;
 padding:8px;
 background:#080c18;
 color:white;
 border:1px solid #2a3366;
 border-radius:8px;
 margin:4px 0;
}

.small{
 font-size:13px;
 color:#b8c0ff;
 margin-top:8px;
 line-height:1.6;
}

.flex{
 display:flex;
 justify-content:space-between;
 align-items:center;
}

canvas{margin-top:12px}

</style>
</head>

<body>

<header>
AntiquaVision â€” Master Dashboard
</header>

<div class="container">

<!-- IMPORT -->

<div class="card">

<h3>ğŸ“‚ Importa File</h3>

<input type="file" id="file">

<button onclick="loadFile()">Analizza</button>

<div id="res"></div>

</div>

<!-- KPI -->

<div class="card">

<h3>ğŸ“Š KPI Principali</h3>

<div class="grid" id="kpi"></div>

</div>

<!-- GRAFICI -->

<div id="charts"></div>

<!-- SCANNER -->

<div class="card">

<h3>ğŸ“¸ Scanner Antiquariato</h3>

<input type="file" id="scanImg">

<button onclick="scanObject()">Analizza Foto</button>

<div id="scanResult" class="small"></div>

<button onclick="openLens()">Google Lens</button>
<button onclick="openBing()">Bing</button>

</div>

<!-- AI SEARCH -->

<div class="card">

<h3>ğŸ§  Ricerca AI</h3>

<input id="aiQuery" placeholder="Scrivi domanda">

<button onclick="aiSearch()">Cerca</button>

<div id="aiAnswer" class="small"></div>

</div>

<!-- SHOP -->

<div class="card">

<h3>ğŸ›’ Analisi Shop</h3>

<button onclick="analyzeShop()">Analizza shop</button>

<div id="shopData" class="small"></div>

<canvas id="shopChart"></canvas>

</div>

<!-- AI -->

<div class="card">

<h3>ğŸ¤– Consulente AI</h3>

<div id="ai"></div>

</div>

</div>

<script>

/* ================= DATA ================= */

let all=[];
let charts={};

const COLORS=[
 "#4f9cff","#3ad29f","#ff6b6b",
 "#9b7bff","#ffd966","#ff9f43",
 "#00cec9","#fd79a8","#6c5ce7"
];

/* ================= UTILS ================= */

function num(v){
 return Number(String(v||"")
 .replace("â‚¬","")
 .replace(",",".")
 .replace(/\s/g,""))||0;
}

/* ================= LOAD ================= */

function loadFile(){

 let f=file.files[0];
 if(!f)return;

 let ext=f.name.split(".").pop();

 if(ext==="xlsx"){

  let r=new FileReader();

  r.onload=e=>{
   let wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
   prepare(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
  };

  r.readAsArrayBuffer(f);

 }else{

  Papa.parse(f,{
   header:true,
   skipEmptyLines:true,
   complete:r=>prepare(r.data)
  });

 }
}

/* ================= PREPARE ================= */

function prepare(rows){

 all=rows.map(r=>({

  epoca:r["epoca"]||"",
  tipo:r["TIPOLOGIA"]||"",
  canale:r["luogo di vendita"]||"",
  paese:r["Nazionalita acquirente"]||"",
  mese:r["MeseNorm"]||"",

  prezzo:num(r["prezzo di vendita"]),
  costo:num(r["acquisto"]),
  profitto:num(r["profitto"])

 }));

 res.innerHTML="âœ”ï¸ "+all.length+" record caricati";

 renderAll();
}

/* ================= GROUP ================= */

function group(k,v){

 let o={};

 all.forEach(x=>{
  if(!x[k])return;
  o[x[k]]=(o[x[k]]||0)+x[v];
 });

 return o;
}

function avgGroup(k,v){

 let o={},c={};

 all.forEach(x=>{
  if(!x[k])return;

  o[x[k]]=(o[x[k]]||0)+x[v];
  c[x[k]]=(c[x[k]]||0)+1;
 });

 let r={};

 for(let i in o){
  r[i]=o[i]/c[i];
 }

 return r;
}

/* ================= DRAW ================= */

function draw(id,title,obj,type){

 if(charts[id])charts[id].destroy();

 charts[id]=new Chart(document.getElementById(id),{

  type,

  data:{
   labels:Object.keys(obj),
   datasets:[{
    label:title,
    data:Object.values(obj),
    backgroundColor:Object.keys(obj)
      .map((_,i)=>COLORS[i%COLORS.length]),
    borderWidth:1
   }]
  }

 });
}

/* ================= KPI ================= */

function renderKPI(){

 let r=0,c=0,p=0;

 all.forEach(x=>{
  r+=x.prezzo;
  c+=x.costo;
  p+=x.profitto;
 });

 let roi=(p/c*100)||0;

 kpi.innerHTML=`

 <div class="kpi">${r.toFixed(0)}â‚¬<br>Ricavi</div>
 <div class="kpi">${c.toFixed(0)}â‚¬<br>Costi</div>
 <div class="kpi">${p.toFixed(0)}â‚¬<br>Profitto</div>
 <div class="kpi">${roi.toFixed(1)}%<br>ROI</div>
 <div class="kpi">${all.length}<br>Vendite</div>

 `;
}

/* ================= CHARTS ================= */

function renderCharts(){

 const list=[

 ["canale","prezzo","Ricavi per Canale","bar"],
 ["canale","profitto","Profitto per Canale","bar"],

 ["epoca","prezzo","Ricavi per Epoca","bar"],
 ["epoca","profitto","Profitto per Epoca","bar"],

 ["tipo","prezzo","Ricavi per Tipologia","bar"],
 ["tipo","profitto","Profitto per Tipologia","bar"],

 ["paese","prezzo","Ricavi per Paese","bar"],
 ["paese","profitto","Profitto per Paese","bar"],

 ["mese","prezzo","Vendite Mensili","line"],
 ["mese","profitto","Profitto Mensile","line"],

 ["epoca","profitto","ROI per Epoca","line"],
 ["tipo","profitto","ROI per Tipologia","line"],

 ["canale","profitto","ROI per Canale","line"],

 ["tipo","prezzo","Prezzo Totale per Tipo","bar"],

 ["epoca","prezzo","Prezzo Totale per Epoca","bar"]

 ];

 charts.innerHTML="";

 list.forEach((x,i)=>{

  let id="c"+i;

  charts.innerHTML+=`

  <div class="card">

  <h3>${x[2]}</h3>

  <canvas id="${id}"></canvas>

  </div>

  `;

  let o=group(x[0],x[1]);

  draw(id,x[2],o,x[3]);

 });

 /* Prezzo Medio */

 let avg1=avgGroup("epoca","prezzo");
 addExtra("Prezzo Medio per Epoca",avg1,"bar");

 let avg2=avgGroup("canale","prezzo");
 addExtra("Prezzo Medio per Canale",avg2,"bar");

 /* Premium */

 let prem=analyzePremium();
 addExtra("Premium >1000â‚¬",prem,"doughnut");
}

/* ================= EXTRA ================= */

function addExtra(title,obj,type){

 let id="x"+Math.random().toString(36).substr(2,6);

 charts.innerHTML+=`

 <div class="card">

 <h3>${title}</h3>

 <canvas id="${id}"></canvas>

 </div>

 `;

 draw(id,title,obj,type);
}

/* ================= PREMIUM ================= */

function analyzePremium(){

 let rev=0,pr=0;

 all.forEach(x=>{
  rev+=x.prezzo;
  if(x.prezzo>=1000)pr+=x.prezzo;
 });

 return{
  "Premium >1000â‚¬":pr,
  "Altri":rev-pr
 };
}

/* ================= FORECAST ================= */

function forecast(){

 let m=group("mese","prezzo");

 let v=Object.values(m);

 if(v.length<2)return "N/D";

 let t=(v[v.length-1]-v[0])/v.length;

 return t>0?"ğŸ“ˆ Crescita":"ğŸ“‰ Calo";
}

/* ================= AI ================= */

function renderAI(){

 let best=max(group("epoca","profitto"));

 ai.innerHTML=`

 ğŸ›ï¸ Miglior epoca: <b>${best}</b><br>
 ğŸ“Š Trend: ${forecast()}<br><br>

 ğŸ’¡ Consiglio:
 Concentrati sulle epoche con ROI alto

 `;
}

function max(o){

 let m=-1e9,k="N/D";

 for(let x in o){
  if(o[x]>m){m=o[x];k=x;}
 }

 return k;
}

/* ================= MAIN ================= */

function renderAll(){

 renderKPI();

 renderCharts();

 renderAI();
}

/* ================= SCANNER ================= */

function scanObject(){

 scanResult.innerHTML="â³ Analisi...";

 setTimeout(()=>{

  scanResult.innerHTML="Epoca XIXâ€“XX â€¢ Valore 900â‚¬â€“2500â‚¬";

 },2000);
}

function openLens(){
 window.open("https://lens.google.com/upload");
}

function openBing(){
 window.open("https://www.bing.com/visualsearch");
}

/* ================= AI SEARCH ================= */

function aiSearch(){

 aiAnswer.innerHTML="â³ Analisi...";

 setTimeout(()=>{

  aiAnswer.innerHTML="Buon investimento sotto 1500â‚¬";

 },2000);
}

/* ================= SHOP ================= */

function analyzeShop(){

 shopData.innerHTML="â³ Analisi shop...";

 fetch("https://api.allorigins.win/raw?url=https://shop.tuttoantico.it")
 .then(r=>r.text())
 .then(html=>{

  let prices=[...html.matchAll(/â‚¬\s?([0-9\.]+)/g)]
   .map(x=>Number(x[1].replace(".","")));

  if(!prices.length){
   shopData.innerHTML="Dati non leggibili";
   return;
  }

  let avg=prices.reduce((a,b)=>a+b,0)/prices.length;

  shopData.innerHTML=`
 Prodotti: ${prices.length}<br>
 Prezzo medio: ${avg.toFixed(0)}â‚¬
 `;

  let o={};

  prices.forEach((p,i)=>o["P"+i]=p);

  draw("shopChart","Prezzi Shop",o,"bar");

 });
}

</script>

</body>
</html>
