<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>AntiquaVision Ultimate Enterprise</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>

body{
 margin:0;
 background:#0b0e14;
 color:#eee;
 font-family:Arial;
}

header{
 background:#111;
 padding:20px;
 text-align:center;
 color:gold;
 font-size:26px;
 font-weight:bold;
}

.container{
 max-width:1900px;
 margin:auto;
 padding:20px;
}

.card{
 background:#151922;
 padding:22px;
 border-radius:14px;
 margin-bottom:25px;
}

button{
 background:gold;
 border:none;
 padding:8px 15px;
 border-radius:7px;
 font-weight:bold;
 cursor:pointer;
}

input,select{
 width:100%;
 padding:7px;
 margin:5px 0;
 background:#0b0e14;
 color:white;
 border:1px solid #333;
}

select.inline{
 width:auto;
 margin-right:10px;
}

.grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
 gap:15px;
}

.kpi{
 background:#0b0e14;
 border:1px solid #333;
 padding:14px;
 border-radius:9px;
 text-align:center;
}

.flex{
 display:flex;
 justify-content:space-between;
 align-items:center;
}

.small{
 font-size:13px;
 color:#aaa;
}

</style>
</head>

<body>

<header>
AntiquaVision â€” Ultimate Business Intelligence
</header>

<div class="container">

<!-- IMPORT -->

<div class="card">

<h3>ğŸ“‚ Import Dati</h3>

<b>Dati Interni</b>
<input type="file" id="fileInternal">
<button onclick="loadInternal()">Importa</button>

<br><br>

<b>Dati Shop</b>
<input type="file" id="fileShop">
<button onclick="loadShop()">Importa</button>

<div id="res"></div>

</div>

<!-- FILTRI -->

<div class="card">

<h3>ğŸ¯ Filtri</h3>

<select id="filterChannel" class="inline" onchange="applyFilters()"></select>
<select id="filterEra" class="inline" onchange="applyFilters()"></select>
<select id="filterCountry" class="inline" onchange="applyFilters()"></select>
<select id="filterType" class="inline" onchange="applyFilters()"></select>

<button onclick="resetFilters()">Reset</button>

</div>

<!-- KPI -->

<div class="card">

<h3>ğŸ“Š Dashboard</h3>

<div class="grid" id="kpi"></div>

</div>

<!-- CHARTS -->

<div class="card">
<div class="flex">
<h3>ğŸ“ˆ Ricavi per Canale</h3>
<select id="t1" onchange="drawCharts()">
<option>bar</option><option>line</option><option>pie</option><option>doughnut</option>
</select>
</div>
<canvas id="c1"></canvas>
</div>

<div class="card">
<div class="flex">
<h3>ğŸ’° Profitto per Epoca</h3>
<select id="t2" onchange="drawCharts()">
<option>bar</option><option>line</option><option>pie</option><option>doughnut</option>
</select>
</div>
<canvas id="c2"></canvas>
</div>

<div class="card">
<div class="flex">
<h3>ğŸŒ Vendite per Paese</h3>
<select id="t3" onchange="drawCharts()">
<option>bar</option><option>pie</option><option>doughnut</option>
</select>
</div>
<canvas id="c3"></canvas>
</div>

<div class="card">
<div class="flex">
<h3>ğŸº Profitto per Tipologia</h3>
<select id="t4" onchange="drawCharts()">
<option>bar</option><option>pie</option><option>doughnut</option>
</select>
</div>
<canvas id="c4"></canvas>
</div>

<div class="card">
<div class="flex">
<h3>ğŸ’ Prezzo Medio Epoca Ã— Canale</h3>
<select id="t5" onchange="drawCharts()">
<option>bar</option><option>line</option><option>pie</option>
</select>
</div>
<canvas id="c5"></canvas>
</div>

<!-- AI -->

<div class="card">

<h3>ğŸ¤– Consulente AI</h3>

<div id="ai"></div>

</div>

<!-- Q&A -->

<div class="card">

<h3>ğŸ’¬ Domande Business</h3>

<div class="small">
Esempi:<br>
â€¢ Cosa comprano gli americani<br>
â€¢ Paese piÃ¹ profittevole<br>
â€¢ Dove perdo soldi<br>
â€¢ Miglior canale<br>
â€¢ Miglior epoca
</div>

<input id="question">

<button onclick="askQuestion()">Chiedi</button>

<div id="answer" style="margin-top:10px;color:gold;"></div>

</div>

</div>

<script>

/* ================= DATA ================= */

let internal=[],shop=[],all=[],filtered=[];
let charts={};

/* ================= UTILS ================= */

function num(v){
 return Number(
  String(v||"")
  .replace("â‚¬","")
  .replace("%","")
  .replace(",",".")
  .replace(/\s/g,"")
 )||0;
}

/* ================= FILE ================= */

function readFile(file,cb){

 let ext=file.name.split(".").pop().toLowerCase();

 if(ext==="xlsx"){

  let r=new FileReader();

  r.onload=e=>{
   let wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
   let s=wb.Sheets[wb.SheetNames[0]];
   cb(XLSX.utils.sheet_to_json(s));
  };

  r.readAsArrayBuffer(file);

 }else{

  Papa.parse(file,{
   header:true,
   skipEmptyLines:true,
   complete:r=>cb(r.data)
  });
 }
}

/* ================= LOAD ================= */

function loadInternal(){

 let f=fileInternal.files[0];
 if(!f) return;

 readFile(f,d=>{

  internal=d.map(r=>({

   nome:r["Merce venduta"]||"",
   tipo:r["TIPOLOGIA"]||"",
   epoca:r["epoca"]||"",
   paese:r["Nazionalita acquirente"]||"",
   sito:r["luogo di vendita"]||"Offline",
   mese:r["MeseNorm"]||"",

   prezzo:num(r["prezzo di vendita"]),
   costo:num(r["acquisto"]),
   profitto:num(r["profitto"]),
   margine:num(r["margine %"])

  }));

  update();
 });
}

function loadShop(){

 let f=fileShop.files[0];
 if(!f) return;

 readFile(f,d=>{

  shop=d.map(r=>({

   nome:r["Product name"]||"",
   sito:"Online",

   prezzo:num(r["Total"]||0),
   costo:0,
   profitto:num(r["Total"]||0)*0.4,
   margine:40

  }));

  update();
 });
}

/* ================= UPDATE ================= */

function update(){

 all=[...internal,...shop];
 filtered=[...all];

 res.innerHTML="âœ”ï¸ Record: "+all.length;

 buildFilters();
 render();
}

/* ================= FILTERS ================= */

function buildFilters(){

 fill(filterChannel,"sito","Tutti Canali");
 fill(filterEra,"epoca","Tutte Epoche");
 fill(filterCountry,"paese","Tutti Paesi");
 fill(filterType,"tipo","Tutte Tipologie");
}

function fill(el,key,label){

 let set=new Set();

 internal.forEach(x=>{
  if(x[key]) set.add(x[key]);
 });

 el.innerHTML=`<option value="">${label}</option>`;

 set.forEach(v=>{
  el.innerHTML+=`<option>${v}</option>`;
 });
}

function applyFilters(){

 filtered=all.filter(x=>{

  if(filterChannel.value && x.sito!==filterChannel.value) return false;
  if(filterEra.value && x.epoca!==filterEra.value) return false;
  if(filterCountry.value && x.paese!==filterCountry.value) return false;
  if(filterType.value && x.tipo!==filterType.value) return false;

  return true;
 });

 render();
}

function resetFilters(){

 filterChannel.value="";
 filterEra.value="";
 filterCountry.value="";
 filterType.value="";

 filtered=[...all];

 render();
}

/* ================= GROUP ================= */

function group(arr,k,v){

 let o={};

 arr.forEach(x=>{
  if(!x[k]) return;
  o[x[k]]=(o[x[k]]||0)+(v?x[v]:1);
 });

 return o;
}

/* ================= DRAW ================= */

function draw(id,label,obj,type){

 if(charts[id]) charts[id].destroy();

 charts[id]=new Chart(document.getElementById(id),{
  type:type,
  data:{
   labels:Object.keys(obj),
   datasets:[{
    label,
    data:Object.values(obj),
    backgroundColor:"gold"
   }]
  }
 });
}

/* ================= RENDER ================= */

function render(){

 if(!filtered.length) return;

 renderKPI();
 drawCharts();
 renderAI();
 renderEnterprise();
}

/* ================= KPI ================= */

function renderKPI(){

 let r=0,c=0,p=0;

 filtered.forEach(x=>{
  r+=x.prezzo;
  c+=x.costo;
  p+=x.profitto;
 });

 let roi=(p/c*100)||0;

 kpi.innerHTML=`

 <div class="kpi"><b>${r.toFixed(0)}â‚¬</b><br>Ricavi</div>
 <div class="kpi"><b>${c.toFixed(0)}â‚¬</b><br>Costi</div>
 <div class="kpi"><b>${p.toFixed(0)}â‚¬</b><br>Profitto</div>
 <div class="kpi"><b>${roi.toFixed(1)}%</b><br>ROI</div>
 <div class="kpi"><b>${filtered.length}</b><br>Vendite</div>

 `;
}

/* ================= CHARTS ================= */

function drawCharts(){

 draw("c1","Ricavi",group(filtered,"sito","prezzo"),t1.value);
 draw("c2","Profitto",group(filtered,"epoca","profitto"),t2.value);
 draw("c3","Paesi",group(filtered,"paese","prezzo"),t3.value);
 draw("c4","Tipologie",group(filtered,"tipo","profitto"),t4.value);

 drawAvg();
}

function drawAvg(){

 let map={};

 filtered.forEach(x=>{

  if(!x.epoca||!x.sito) return;

  let k=x.sito+" / "+x.epoca;

  if(!map[k]) map[k]={t:0,c:0};

  map[k].t+=x.prezzo;
  map[k].c++;
 });

 let r={};

 for(let k in map){
  r[k]=map[k].t/map[k].c;
 }

 draw("c5","Prezzo Medio",r,t5.value);
}

/* ================= AI ================= */

function renderAI(){

 let bestC=max(group(filtered,"sito","profitto"));
 let bestE=max(group(filtered,"epoca","profitto"));
 let bestT=max(group(filtered,"tipo","profitto"));

 ai.innerHTML=`

 âœ… Miglior canale: <b>${bestC}</b><br>
 ğŸ›ï¸ Miglior epoca: <b>${bestE}</b><br>
 ğŸº Miglior tipologia: <b>${bestT}</b><br>

 `;
}

/* ================= ENTERPRISE ================= */

function renderEnterprise(){

 let losses = filtered.filter(x=>x.profitto<0).length;
 let trend = forecast();
 let budget = planBudget();
 let risk = riskIndex();

 ai.innerHTML += `

 <hr>

 âŒ Vendite in perdita: <b>${losses}</b><br>
 ğŸ“ˆ Trend: <b>${trend}</b><br>
 ğŸ’¸ Budget consigliato: <b>${budget}â‚¬</b><br>
 ğŸš¨ Rischio: <b>${risk}</b><br>

 `;
}

function forecast(){

 let m=group(filtered,"mese","prezzo");
 let v=Object.values(m);

 if(v.length<2) return "Insufficiente";

 return v[v.length-1]>v[0]?"Crescita":"Calo";
}

function planBudget(){

 let p=0;

 filtered.forEach(x=>p+=x.profitto);

 return Math.round(p*0.4);
}

function riskIndex(){

 let l=filtered.filter(x=>x.profitto<0).length;

 let r=l/filtered.length;

 if(r<0.1) return "Basso";
 if(r<0.25) return "Medio";

 return "Alto";
}

/* ================= Q&A ================= */

function askQuestion(){

 let q=question.value.toLowerCase();
 let res="Nessun dato.";

 if(q.includes("usa")||q.includes("america")){
  res="ğŸ‡ºğŸ‡¸ Comprano: "+max(group(filtered,"tipo","prezzo"));
 }

 if(q.includes("paese")&&q.includes("profit")){
  res="ğŸŒ Miglior paese: "+max(group(filtered,"paese","profitto"));
 }

 if(q.includes("perdo")){
  res="âš ï¸ Perdi su: "+min(group(filtered,"sito","profitto"));
 }

 if(q.includes("canale")){
  res="ğŸ† Miglior canale: "+max(group(filtered,"sito","profitto"));
 }

 if(q.includes("epoca")){
  res="ğŸ›ï¸ Miglior epoca: "+max(group(filtered,"epoca","profitto"));
 }

 answer.innerHTML=res;
}

/* ================= MIN MAX ================= */

function max(o){

 let m=-1e9,k="";

 for(let x in o){
  if(o[x]>m){m=o[x];k=x;}
 }

 return k||"N/D";
}

function min(o){

 let m=1e9,k="";

 for(let x in o){
  if(o[x]<m){m=o[x];k=x;}
 }

 return k||"N/D";
}

</script>

</body>
</html>
