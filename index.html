<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Antiqua Vision Pro</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>

body{
 margin:0;
 background:#0b0e14;
 color:#eee;
 font-family:Arial;
}

header{
 background:#111;
 padding:15px;
 text-align:center;
 color:gold;
 font-size:24px;
 font-weight:bold;
}

.container{
 max-width:1600px;
 margin:auto;
 padding:20px;
}

.card{
 background:#151922;
 padding:20px;
 border-radius:12px;
 margin-bottom:20px;
}

button{
 background:gold;
 border:none;
 padding:7px 14px;
 border-radius:6px;
 font-weight:bold;
 cursor:pointer;
}

input,select{
 width:100%;
 padding:7px;
 margin:4px 0;
 background:#0b0e14;
 color:white;
 border:1px solid #333;
}

.inline{width:auto}

.grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
 gap:12px;
}

.kpi{
 background:#0b0e14;
 border:1px solid #333;
 padding:12px;
 border-radius:8px;
 text-align:center;
}

.flex{
 display:flex;
 justify-content:space-between;
 align-items:center;
}

.small{font-size:12px;color:#aaa}

hr{border:1px solid #222;margin:15px 0}

</style>
</head>

<body>

<header>
Antiqua Vision â€” Business Intelligence Pro
</header>

<div class="container">

<!-- IMPORT -->

<div class="card">

<h3>ğŸ“‚ Importa File Excel / CSV</h3>

<input type="file" id="file">

<button onclick="loadFile()">Analizza</button>

<div id="res"></div>

</div>

<!-- KPI -->

<div class="card">

<h3>ğŸ“Š Dashboard</h3>

<div class="grid" id="kpi"></div>

</div>

<!-- GRAFICI -->

<div class="card">
<h3>ğŸ“ˆ Ricavi per Canale</h3>
<select id="t1" onchange="drawCharts()">
<option>bar</option><option>line</option><option>pie</option><option>doughnut</option>
</select>
<canvas id="c1"></canvas>
</div>

<div class="card">
<h3>ğŸ›ï¸ Profitto per Epoca</h3>
<select id="t2" onchange="drawCharts()">
<option>bar</option><option>line</option><option>pie</option><option>doughnut</option>
</select>
<canvas id="c2"></canvas>
</div>

<div class="card">
<h3>ğŸŒ Vendite per Paese</h3>
<select id="t3" onchange="drawCharts()">
<option>bar</option><option>pie</option><option>doughnut</option>
</select>
<canvas id="c3"></canvas>
</div>

<div class="card">
<h3>ğŸº Tipologie</h3>
<select id="t4" onchange="drawCharts()">
<option>bar</option><option>pie</option><option>doughnut</option>
</select>
<canvas id="c4"></canvas>
</div>

<div class="card">
<h3>ğŸ’ Prezzo Medio Epoca Ã— Canale</h3>
<select id="t5" onchange="drawCharts()">
<option>bar</option><option>line</option>
</select>
<canvas id="c5"></canvas>
</div>

<!-- STRATEGIA PREZZI -->

<div class="card">

<h3>ğŸ’° Strategia Fasce di Prezzo</h3>

<div id="priceAI"></div>

<canvas id="c6"></canvas>

</div>

<!-- AI -->

<div class="card">

<h3>ğŸ¤– Consulente AI</h3>

<div id="ai"></div>

</div>

<!-- DOMANDE -->

<div class="card">

<h3>ğŸ’¬ Domande Business</h3>

<div class="small">
Esempi: paese profitto, fascia migliore, epoca premium, dove investire
</div>

<input id="question">

<button onclick="ask()">Chiedi</button>

<div id="answer" style="color:gold;margin-top:8px"></div>

</div>

<button onclick="exportCSV()">ğŸ“¤ Export Report</button>

</div>

<script>

/* DATA */

let all=[],filtered=[];
let charts={};

/* LOAD */

function loadFile(){

 let f=file.files[0];

 if(!f) return alert("Carica un file");

 let ext=f.name.split(".").pop().toLowerCase();

 if(ext==="xlsx"){

  let r=new FileReader();

  r.onload=e=>{

   let wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
   let json=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

   prepare(json);
  };

  r.readAsArrayBuffer(f);

 }else{

  Papa.parse(f,{
   header:true,
   skipEmptyLines:true,
   complete:r=>prepare(r.data)
  });
 }
}

/* PREPARE */

function prepare(rows){

 all=rows.map(r=>({

  nome:r["Merce venduta"]||"",
  tipo:r["TIPOLOGIA"]||"",
  epoca:r["epoca"]||"",
  paese:r["Nazionalita acquirente"]||"",
  canale:r["luogo di vendita"]||"",

  prezzo:num(r["prezzo di vendita"]),
  costo:num(r["acquisto"]),
  profitto:num(r["profitto"])

 }));

 filtered=[...all];

 res.innerHTML="âœ”ï¸ Record: "+all.length;

 render();
}

/* NUM */

function num(v){

 return Number(String(v||"")
 .replace("â‚¬","")
 .replace("%","")
 .replace(",",".")
 .replace(/\s/g,""))||0;
}

/* GROUP */

function group(arr,k,v){

 let o={};

 arr.forEach(x=>{
  if(!x[k])return;
  o[x[k]]=(o[x[k]]||0)+x[v];
 });

 return o;
}

/* RENDER */

function render(){

 if(!filtered.length)return;

 renderKPI();
 drawCharts();
 renderAI();
 renderPriceStrategy();
}

/* KPI */

function renderKPI(){

 let r=0,c=0,p=0;

 filtered.forEach(x=>{
  r+=x.prezzo;
  c+=x.costo;
  p+=x.profitto;
 });

 let roi=(p/c*100)||0;

 kpi.innerHTML=`

 <div class="kpi"><b>${r.toFixed(0)}â‚¬</b><br>Ricavi</div>
 <div class="kpi"><b>${c.toFixed(0)}â‚¬</b><br>Costi</div>
 <div class="kpi"><b>${p.toFixed(0)}â‚¬</b><br>Profitto</div>
 <div class="kpi"><b>${roi.toFixed(1)}%</b><br>ROI</div>
 <div class="kpi"><b>${filtered.length}</b><br>Vendite</div>

 `;
}

/* CHARTS */

function drawCharts(){

 draw("c1","Ricavi",group(filtered,"canale","prezzo"),t1.value);
 draw("c2","Profitto",group(filtered,"epoca","profitto"),t2.value);
 draw("c3","Paesi",group(filtered,"paese","prezzo"),t3.value);
 draw("c4","Tipologie",group(filtered,"tipo","profitto"),t4.value);

 drawAvg();
 drawPriceBands();
}

function draw(id,label,obj,type){

 if(charts[id]) charts[id].destroy();

 charts[id]=new Chart(document.getElementById(id),{
  type,
  data:{
   labels:Object.keys(obj),
   datasets:[{
    label,
    data:Object.values(obj),
    backgroundColor:"gold"
   }]
  }
 });
}

/* AVG */

function drawAvg(){

 let m={};

 filtered.forEach(x=>{

  if(!x.epoca||!x.canale)return;

  let k=x.canale+" / "+x.epoca;

  if(!m[k])m[k]={t:0,c:0};

  m[k].t+=x.prezzo;
  m[k].c++;
 });

 let r={};

 for(let k in m)r[k]=m[k].t/m[k].c;

 draw("c5","Prezzo Medio",r,t5.value);
}

/* FASCE PREZZO */

function drawPriceBands(){

 let bands={
  "0-200":0,
  "200-500":0,
  "500-1000":0,
  "1000+":0
 };

 filtered.forEach(x=>{

  let p=x.prezzo;

  if(p<=200)bands["0-200"]++;
  else if(p<=500)bands["200-500"]++;
  else if(p<=1000)bands["500-1000"]++;
  else bands["1000+"]++;
 });

 draw("c6","Fasce Prezzo",bands,"bar");
}

/* AI */

function renderAI(){

 let bestC=max(group(filtered,"canale","profitto"));
 let bestE=max(group(filtered,"epoca","profitto"));
 let bestT=max(group(filtered,"tipo","profitto"));

 ai.innerHTML=`

 âœ… Miglior canale: <b>${bestC}</b><br>
 ğŸ›ï¸ Epoca migliore: <b>${bestE}</b><br>
 ğŸº Tipologia top: <b>${bestT}</b><br>

 `;
}

/* STRATEGIA PREZZI */

function renderPriceStrategy(){

 let premium=filtered.filter(x=>x.prezzo>=1000);

 let ep={};
 let tp={};

 premium.forEach(x=>{

  ep[x.epoca]=(ep[x.epoca]||0)+1;
  tp[x.tipo]=(tp[x.tipo]||0)+1;

 });

 let bestEra=max(ep);
 let bestType=max(tp);

 priceAI.innerHTML=`

 ğŸ“Œ Vendite sopra 1000â‚¬: <b>${premium.length}</b><br><br>

 ğŸ›ï¸ Epoca premium ricorrente: <b>${bestEra}</b><br>
 ğŸº Categoria premium: <b>${bestType}</b><br>

 <hr>

 ğŸ’¡ Strategia:

 <br>â€¢ Le fasce sopra 1000â‚¬ funzionano soprattutto in: <b>${bestEra}</b>
 <br>â€¢ Le categorie piÃ¹ stabili: <b>${bestType}</b>
 <br>â€¢ Conviene mantenere mix tra medio e premium

 `;
}

/* Q&A */

function ask(){

 let q=question.value.toLowerCase();
 let r="Nessun dato.";

 if(q.includes("fascia"))
  r="ğŸ’° Migliore: "+max(group(filtered,"epoca","prezzo"));

 if(q.includes("premium"))
  r="ğŸ’ "+max(group(filtered.filter(x=>x.prezzo>1000),"epoca","prezzo"));

 if(q.includes("epoca"))
  r="ğŸ›ï¸ "+max(group(filtered,"epoca","profitto"));

 if(q.includes("canale"))
  r="ğŸ† "+max(group(filtered,"canale","profitto"));

 if(q.includes("paese"))
  r="ğŸŒ "+max(group(filtered,"paese","profitto"));

 answer.innerHTML=r;
}

/* EXPORT */

function exportCSV(){

 let csv="Nome,Prezzo,Profitto,Canale,Paese\n";

 filtered.forEach(x=>{
  csv+=`${x.nome},${x.prezzo},${x.profitto},${x.canale},${x.paese}\n`;
 });

 let b=new Blob([csv]);

 let a=document.createElement("a");

 a.href=URL.createObjectURL(b);
 a.download="report_antiquavision.csv";

 a.click();
}

/* MAX */

function max(o){

 let m=-1e9,k="N/D";

 for(let x in o){
  if(o[x]>m){m=o[x];k=x;}
 }

 return k;
}

</script>

</body>
</html>
