<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>AntiquaVision Smart PRO+</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{margin:0;background:#0b0e14;color:#eee;font-family:Arial}
header{background:#111;padding:15px;text-align:center;color:gold;font-size:22px}
.container{max-width:1400px;margin:auto;padding:20px}
.card{background:#151922;padding:20px;border-radius:12px;margin-bottom:20px}
button{background:gold;border:none;padding:8px 14px;border-radius:6px;font-weight:bold;cursor:pointer}
input,select{width:100%;padding:7px;margin:5px 0;background:#0b0e14;color:white;border:1px solid #333}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid #333;padding:6px}
th{color:gold}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px}
.kpi{background:#0b0e14;border:1px solid #333;padding:12px;border-radius:8px;text-align:center}
</style>
</head>

<body>

<header>AntiquaVision Smart PRO+</header>

<div class="container">

<!-- IMPORT -->
<div class="card">
<h3>üìÇ Import File</h3>
<input type="file" id="fileInput">
<button onclick="loadFile()">Analizza</button>
<div id="result"></div>
</div>

<!-- KPI -->
<div class="card">
<h3>üìä KPI</h3>
<div class="grid" id="kpi"></div>
</div>

<!-- SIMULATORE -->
<div class="card">
<h3>üí° Simulatore Investimento</h3>
<input id="simCost" placeholder="Costo previsto">
<input id="simPrice" placeholder="Prezzo previsto">
<button onclick="simulate()">Simula</button>
<div id="simRes"></div>
</div>

<!-- GRAFICI -->
<div class="card">
<h3>üìà Vendite per Mese</h3>
<select id="typeSales" onchange="drawSales()">
<option>bar</option><option>line</option><option>pie</option><option>doughnut</option>
</select>
<canvas id="salesChart"></canvas>
</div>

<!-- AI -->
<div class="card">
<h3>ü§ñ AI Advisor</h3>
<div id="ai"></div>
</div>

<!-- ADD MANUAL -->
<div class="card">
<h3>‚ûï Aggiungi Vendita</h3>

<input id="n_nome" placeholder="Nome">
<input id="n_mese" placeholder="Mese (2025-01)">
<input id="n_paese" placeholder="Paese">
<input id="n_sito" placeholder="Canale">
<input id="n_prezzo" placeholder="Prezzo">
<input id="n_costo" placeholder="Costo">
<input id="n_epoca" placeholder="Epoca">

<button onclick="addManual()">Salva</button>
</div>

<!-- TABLE -->
<div class="card">
<h3>üìã Tutti i Dati</h3>
<table id="table"></table>
</div>

</div>

<script>

let data=JSON.parse(localStorage.getItem("avData")||"[]");
let chart=null;

/* SAVE */
function save(){
 localStorage.setItem("avData",JSON.stringify(data));
}

/* LOAD FILE */
function loadFile(){

 let f=fileInput.files[0];
 if(!f)return alert("Seleziona file");

 let ext=f.name.split(".").pop();

 if(ext=="xlsx") excel(f);
 else csv(f);
}

function excel(f){

 let r=new FileReader();

 r.onload=e=>{

  let wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
  let s=wb.Sheets[wb.SheetNames[0]];

  process(XLSX.utils.sheet_to_json(s));
 };

 r.readAsArrayBuffer(f);
}

function csv(f){

 Papa.parse(f,{
  header:true,
  skipEmptyLines:true,
  complete:r=>process(r.data)
 });
}

/* PROCESS */
function process(rows){

 rows.forEach(r=>{

  data.push({
   nome:r["Merce venduta"]||"",
   mese:r["MeseNorm"]||"",
   paese:r["Nazionalita acquirente"]||"",
   sito:r["luogo di vendita"]||"",
   prezzo:num(r["prezzo di vendita"]),
   costo:num(r["acquisto"]),
   profitto:num(r["profitto"]),
   epoca:r["epoca"]||""
  });

 });

 save();
 render();

 result.innerHTML="‚úîÔ∏è Import completato";
}

function num(v){
 return Number(String(v||"").replace("‚Ç¨","").replace("%","").replace(",",".").replace(/\s/g,""))||0;
}

/* ADD */
function addManual(){

 data.push({
  nome:n_nome.value,
  mese:n_mese.value,
  paese:n_paese.value,
  sito:n_sito.value,
  prezzo:num(n_prezzo.value),
  costo:num(n_costo.value),
  profitto:num(n_prezzo.value)-num(n_costo.value),
  epoca:n_epoca.value
 });

 save();
 render();

 alert("Aggiunto ‚úîÔ∏è");
}

/* SIMULATE */
function simulate(){

 let c=num(simCost.value);
 let p=num(simPrice.value);

 let prof=p-c;

 simRes.innerHTML=
  `Profitto stimato: <b>${prof}‚Ç¨</b>`+
  (prof>0?" ‚úÖ Conviene":" ‚ùå Rischioso");
}

/* RENDER */
function render(){

 renderKPI();
 renderTable();
 drawSales();
 renderAI();
}

function renderKPI(){

 let rev=0,prof=0;

 data.forEach(x=>{
  rev+=x.prezzo;
  prof+=x.profitto;
 });

 kpi.innerHTML=`

 <div class="kpi"><b>${rev.toFixed(0)}</b><br>Entrate</div>
 <div class="kpi"><b>${prof.toFixed(0)}</b><br>Profitto</div>
 <div class="kpi"><b>${data.length}</b><br>Record</div>

 `;
}

/* TABLE */
function renderTable(){

 let h="<tr><th>Nome</th><th>Mese</th><th>Paese</th><th>Prezzo</th><th>Profitto</th></tr>";

 data.forEach(x=>{
  h+=`
  <tr>
   <td>${x.nome}</td>
   <td>${x.mese}</td>
   <td>${x.paese}</td>
   <td>${x.prezzo}</td>
   <td>${x.profitto}</td>
  </tr>`;
 });

 table.innerHTML=h;
}

/* CHART */
function drawSales(){

 let m={};

 data.forEach(x=>{
  if(!x.mese)return;
  m[x.mese]=(m[x.mese]||0)+x.prezzo;
 });

 if(chart) chart.destroy();

 chart=new Chart(salesChart,{
  type:typeSales.value,
  data:{
   labels:Object.keys(m),
   datasets:[{
    label:"Vendite",
    data:Object.values(m),
    backgroundColor:"gold"
   }]
  }
 });
}

/* AI */
function renderAI(){

 let bySite={},byCountry={};

 data.forEach(x=>{
  bySite[x.sito]=(bySite[x.sito]||0)+x.profitto;
  byCountry[x.paese]=(byCountry[x.paese]||0)+x.profitto;
 });

 ai.innerHTML=`

 üîù Miglior canale: <b>${max(bySite)}</b><br>
 üåç Miglior paese: <b>${max(byCountry)}</b><br>
 üìå Consiglio: investi l√¨.

 `;
}

function max(o){

 let m=0,k="N/D";

 for(let i in o){
  if(o[i]>m){m=o[i];k=i}
 }

 return k;
}

/* INIT */
render();

</script>

</body>
</html>
