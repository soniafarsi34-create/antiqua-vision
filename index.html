<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>AntiquaVision SUPREME</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1p/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>

body{
 margin:0;
 background:#0b0e14;
 color:#eee;
 font-family:Arial;
}

header{
 background:#111;
 padding:18px;
 text-align:center;
 color:gold;
 font-size:24px;
 font-weight:bold;
}

.container{
 max-width:1900px;
 margin:auto;
 padding:20px;
}

.card{
 background:#151922;
 padding:22px;
 border-radius:14px;
 margin-bottom:25px;
}

button{
 background:gold;
 border:none;
 padding:8px 15px;
 border-radius:7px;
 font-weight:bold;
 cursor:pointer;
}

input,select{
 width:100%;
 padding:7px;
 margin:5px 0;
 background:#0b0e14;
 color:white;
 border:1px solid #333;
}

select.inline{
 width:auto;
 margin-right:10px;
}

table{
 width:100%;
 border-collapse:collapse;
 font-size:12px;
}

th,td{
 border-bottom:1px solid #333;
 padding:6px;
}

th{color:gold}

.grid{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
 gap:15px;
}

.kpi{
 background:#0b0e14;
 border:1px solid #333;
 padding:14px;
 border-radius:9px;
 text-align:center;
}

</style>
</head>

<body>

<header>
AntiquaVision SUPREME â€” Business Intelligence
</header>

<div class="container">

<!-- IMPORT -->

<div class="card">

<h3>ğŸ“‚ Import Dati</h3>

<input type="file" id="fileInternal">
<button onclick="loadInternal()">Importa Interni</button>

<input type="file" id="fileShop">
<button onclick="loadShop()">Importa Shop</button>

<div id="res"></div>

</div>

<!-- FILTRI -->

<div class="card">

<h3>ğŸ¯ Filtri</h3>

<select id="filterChannel" class="inline" onchange="applyFilters()"></select>
<select id="filterEra" class="inline" onchange="applyFilters()"></select>
<select id="filterCountry" class="inline" onchange="applyFilters()"></select>
<select id="filterType" class="inline" onchange="applyFilters()"></select>

<button onclick="resetFilters()">Reset</button>

</div>

<!-- KPI -->

<div class="card">

<h3>ğŸ“Š Dashboard</h3>

<div class="grid" id="kpi"></div>

</div>

<!-- GRAFICI -->

<div class="card"><h3>ğŸ“ˆ Ricavi per Canale</h3><canvas id="ch1"></canvas></div>
<div class="card"><h3>ğŸ’° Profitto per Epoca</h3><canvas id="ch2"></canvas></div>
<div class="card"><h3>ğŸŒ Vendite per Paese</h3><canvas id="ch3"></canvas></div>
<div class="card"><h3>ğŸº Tipologie</h3><canvas id="ch4"></canvas></div>

<div class="card"><h3>ğŸ”— Canale Ã— Epoca</h3><canvas id="ch5"></canvas></div>
<div class="card"><h3>ğŸ”— Canale Ã— Paese</h3><canvas id="ch6"></canvas></div>
<div class="card"><h3>ğŸ”— Canale Ã— Tipologia</h3><canvas id="ch7"></canvas></div>

<div class="card"><h3>ğŸ“¦ QuantitÃ  per Epoca</h3><canvas id="ch8"></canvas></div>
<div class="card"><h3>ğŸ“¦ QuantitÃ  per Paese</h3><canvas id="ch9"></canvas></div>

<div class="card"><h3>ğŸ’ Prezzo Medio Epoca Ã— Canale</h3><canvas id="ch10"></canvas></div>

<!-- AI -->

<div class="card">
<h3>ğŸ¤– AI Strategica</h3>
<div id="ai"></div>
</div>

<!-- Q&A -->

<div class="card">

<h3>ğŸ’¬ Domande Business</h3>

<input id="question" placeholder="Es: Cosa comprano gli americani?">

<button onclick="askQuestion()">Chiedi</button>

<div id="answer" style="margin-top:10px;color:gold;"></div>

</div>

</div>

<script>

let internal=[];
let shop=[];
let all=[];
let filtered=[];
let charts={};

/* UTILS */

function num(v){
 return Number(
  String(v||"")
  .replace("â‚¬","")
  .replace("%","")
  .replace(",",".")
  .replace(/\s/g,"")
 )||0;
}

/* FILE */

function readFile(file,cb){

 let ext=file.name.split(".").pop().toLowerCase();

 if(ext==="xlsx"){

  let r=new FileReader();

  r.onload=e=>{
   let a=new Uint8Array(e.target.result);
   let wb=XLSX.read(a,{type:"array"});
   let s=wb.Sheets[wb.SheetNames[0]];
   cb(XLSX.utils.sheet_to_json(s));
  };

  r.readAsArrayBuffer(file);

 }else{

  Papa.parse(file,{
   header:true,
   skipEmptyLines:true,
   complete:r=>cb(r.data)
  });
 }
}

/* LOAD */

function loadInternal(){

 let f=fileInternal.files[0];
 if(!f) return;

 readFile(f,d=>{

  internal=d.map(r=>({

   nome:r["Merce venduta"]||"",
   tipo:r["TIPOLOGIA"]||"",
   epoca:r["epoca"]||"",
   paese:r["Nazionalita acquirente"]||"",
   sito:r["luogo di vendita"]||"Offline",

   prezzo:num(r["prezzo di vendita"]),
   costo:num(r["acquisto"]),
   profitto:num(r["profitto"])

  }));

  updateAll();
 });
}

function loadShop(){

 let f=fileShop.files[0];
 if(!f) return;

 readFile(f,d=>{

  shop=d.map(r=>({

   nome:r["Product name"]||"",
   sito:"Online",
   prezzo:num(r["Total"]||0),
   costo:0,
   profitto:num(r["Total"]||0)*0.4
  }));

  updateAll();
 });
}

/* UPDATE */

function updateAll(){

 all=[...internal,...shop];
 filtered=[...all];

 res.innerHTML="âœ”ï¸ Record: "+all.length;

 buildFilters();
 render();
}

/* FILTERS */

function buildFilters(){

 fill(filterChannel,"sito","Tutti Canali");
 fill(filterEra,"epoca","Tutte Epoche");
 fill(filterCountry,"paese","Tutti Paesi");
 fill(filterType,"tipo","Tutte Tipologie");
}

function fill(el,key,label){

 let set=new Set();

 internal.forEach(x=>{
  if(x[key]) set.add(x[key]);
 });

 el.innerHTML=`<option value="">${label}</option>`;

 set.forEach(v=>{
  el.innerHTML+=`<option>${v}</option>`;
 });
}

function applyFilters(){

 filtered=all.filter(x=>{

  if(filterChannel.value && x.sito!==filterChannel.value) return false;
  if(filterEra.value && x.epoca!==filterEra.value) return false;
  if(filterCountry.value && x.paese!==filterCountry.value) return false;
  if(filterType.value && x.tipo!==filterType.value) return false;

  return true;
 });

 render();
}

function resetFilters(){

 filterChannel.value="";
 filterEra.value="";
 filterCountry.value="";
 filterType.value="";

 filtered=[...all];

 render();
}

/* GROUP */

function group(arr,k,v){

 let o={};

 arr.forEach(x=>{
  if(!x[k]) return;
  o[x[k]]=(o[x[k]]||0)+(v?x[v]:1);
 });

 return o;
}

function group2(arr,k1,k2){

 let o={};

 arr.forEach(x=>{

  if(!x[k1]||!x[k2]) return;

  let key=x[k1]+" / "+x[k2];

  o[key]=(o[key]||0)+1;
 });

 return o;
}

/* DRAW */

function draw(id,label,obj){

 if(charts[id]) charts[id].destroy();

 charts[id]=new Chart(document.getElementById(id),{
  type:"bar",
  data:{
   labels:Object.keys(obj),
   datasets:[{
    label,
    data:Object.values(obj),
    backgroundColor:"gold"
   }]
  }
 });
}

/* RENDER */

function render(){

 if(!filtered.length) return;

 renderKPI();
 drawCharts();
 renderAI();
}

/* KPI */

function renderKPI(){

 let r=0,c=0,p=0;

 filtered.forEach(x=>{
  r+=x.prezzo;
  c+=x.costo;
  p+=x.profitto;
 });

 let roi=(p/c*100)||0;

 kpi.innerHTML=`

 <div class="kpi"><b>${r.toFixed(0)}â‚¬</b><br>Ricavi</div>
 <div class="kpi"><b>${c.toFixed(0)}â‚¬</b><br>Costi</div>
 <div class="kpi"><b>${p.toFixed(0)}â‚¬</b><br>Profitto</div>
 <div class="kpi"><b>${roi.toFixed(1)}%</b><br>ROI</div>
 <div class="kpi"><b>${filtered.length}</b><br>Vendite</div>

 `;
}

/* CHARTS */

function drawCharts(){

 draw("ch1","Ricavi",group(filtered,"sito","prezzo"));
 draw("ch2","Profitto",group(filtered,"epoca","profitto"));
 draw("ch3","Paesi",group(filtered,"paese","prezzo"));
 draw("ch4","Tipologie",group(filtered,"tipo","profitto"));

 draw("ch5","Canale/Epoca",group2(filtered,"sito","epoca"));
 draw("ch6","Canale/Paese",group2(filtered,"sito","paese"));
 draw("ch7","Canale/Tipo",group2(filtered,"sito","tipo"));

 draw("ch8","Epoche",group(filtered,"epoca"));
 draw("ch9","Paesi",group(filtered,"paese"));

 drawAvgPrice();
}

function drawAvgPrice(){

 let map={};

 filtered.forEach(x=>{

  if(!x.epoca||!x.sito||!x.prezzo) return;

  let k=x.sito+" / "+x.epoca;

  if(!map[k]) map[k]={t:0,c:0};

  map[k].t+=x.prezzo;
  map[k].c++;
 });

 let res={};

 for(let k in map){
  res[k]=map[k].t/map[k].c;
 }

 draw("ch10","Prezzo Medio",res);
}

/* AI */

function renderAI(){

 let bestChannel=max(group(filtered,"sito","profitto"));
 let bestEra=max(group(filtered,"epoca","profitto"));
 let bestType=max(group(filtered,"tipo","profitto"));

 ai.innerHTML=`

 âœ… Miglior canale: <b>${bestChannel}</b><br>
 ğŸ›ï¸ Miglior epoca: <b>${bestEra}</b><br>
 ğŸº Miglior tipologia: <b>${bestType}</b><br><br>

 ğŸ“Œ Strategia:
 punta su ${bestEra},
 spingi ${bestChannel},
 compra ${bestType}.

 `;
}

/* Q&A */

function askQuestion(){

 let q=question.value.toLowerCase();

 if(!q) return;

 let res="Domanda non riconosciuta.";

 if(q.includes("american")||q.includes("usa")){

  let usa=filtered.filter(x=>
   x.paese.toLowerCase().includes("usa")||
   x.paese.toLowerCase().includes("america")
  );

  let t=group(usa,"tipo","prezzo");
  let best=max(t);

  res="ğŸ‡ºğŸ‡¸ Gli americani comprano soprattutto: "+best;
 }

 if(q.includes("paese")&&q.includes("profit")){

  let p=group(filtered,"paese","profitto");
  let best=max(p);

  res="ğŸŒ Il paese piÃ¹ redditizio Ã¨: "+best;
 }

 if(q.includes("dove")&&q.includes("perdo")){

  let s=group(filtered,"sito","profitto");
  let w=min(s);

  res="âš ï¸ Perdi soprattutto su: "+w;
 }

 answer.innerHTML=res;
}

function max(o){

 let m=-1e9,k="";

 for(let x in o){
  if(o[x]>m){m=o[x];k=x;}
 }

 return k||"N/D";
}

function min(o){

 let m=1e9,k="";

 for(let x in o){
  if(o[x]<m){m=o[x];k=x;}
 }

 return k||"N/D";
}

</script>

</body>
</html>
